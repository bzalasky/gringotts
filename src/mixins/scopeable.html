<!DOCTYPE html><html lang="en"><head><title>src/mixins/scopeable</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="citare-relative-root" content="../../"><meta name="citare-document-path" content="src/mixins/scopeable"><meta name="citare-project-path" content="src/mixins/scopeable.coffee"><meta name="citare-github-url" content="https://github.com/lookout/gringotts"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="bg"></div><div id="meta"><div class="file-path"><a href="https://github.com/lookout/gringotts/blob/master/src/mixins/scopeable.coffee">src/mixins/scopeable.coffee</a></div></div><div id="document" class="codedoc"><div class="segment"><div class="comments"><div class="wrapper"><p>This mixin handles retrieving parameters for storage on the collection
and cleaning up the URL as needed. The parameters will be stored
as <code>params</code> on the collection and the URL will use the <code>syncKey</code>
property on the collection as it&#39;s base.</p>
<p>A <code>DEFAULTS</code> object is required on the collection in addition to a
<code>syncKey</code> string to specify the name of the URL base.</p>
<p>In order for views to take full advantage of this, all calls to <code>fetch</code>
should pass a <code>query</code> key into it&#39;s options in order for associated
parameters (such as sorts, filters, etc.) are preserved between requests.</p>
<p>Private methods need to use <code>call</code> so that the instance is used over the
constructor or global object.</p></div></div><div class="code"><div class="wrapper">define <span class="function"><span class="params">(<span class="built_in">require</span>, <span class="built_in">exports</span>)</span> -&gt;</span>
  _ = <span class="built_in">require</span> <span class="string">'underscore'</span>
  advice = <span class="built_in">require</span> <span class="string">'flight/advice'</span>
  utils = <span class="built_in">require</span> <span class="string">'../lib/utils'</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract params and fill in falsy values with defaults for server request.</p></div></div><div class="code"><div class="wrapper">  <span class="function"><span class="title">_collectParams</span> = <span class="params">(query)</span> -&gt;</span>
    params = utils.queryParams.parse query</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Can&#39;t iterate over params since it might be missing keys.</p></div></div><div class="code"><div class="wrapper">    _.reduce <span class="property">@DEFAULTS</span>, <span class="function"><span class="params">(memo, value, key)</span> -&gt;</span>
      value = params[key] <span class="keyword">or</span> value</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convert string numbers to numbers.</p></div></div><div class="code"><div class="wrapper">      value = +value <span class="keyword">if</span> (+value).toString() <span class="keyword">is</span> value
      memo[key] = value
      memo
    , params</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This will remove default parameters to make the URL “pretty”.</p></div></div><div class="code"><div class="wrapper">  <span class="function"><span class="title">_removeDefaults</span> = <span class="params">(params)</span> -&gt;</span>
    _.reduce params, <span class="function"><span class="params">(memo, value, key)</span> -&gt;</span>
      defaultVal = <span class="property">@DEFAULTS</span>[key]
      comparison =
        <span class="keyword">if</span> _.isArray value
          _.uniq(value.concat defaultVal)
        <span class="keyword">else</span>
          defaultVal</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use <code>isEqual</code> in case the values are arrays</p></div></div><div class="code"><div class="wrapper">      <span class="keyword">unless</span> _.isEqual comparison, value
        memo[key] = value
      memo
    , {}, <span class="keyword">this</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use to construct the URL to route to.</p></div></div><div class="code"><div class="wrapper">  <span class="function"><span class="title">scopedUrl</span> = <span class="params">(scope)</span> -&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>All non-default params passed in will be sent to the server.</p></div></div><div class="code"><div class="wrapper">    params = _.extend {}, <span class="property">@params</span>, scope</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle sort with standard <code>asc</code> and <code>desc</code> order.</p></div></div><div class="code"><div class="wrapper">    <span class="keyword">if</span> scope.sort_by
      params.order = <span class="string">'asc'</span>
      <span class="keyword">if</span> <span class="property">@params</span>.sort_by <span class="keyword">is</span> params.sort_by <span class="keyword">and</span> <span class="property">@params</span>.order <span class="keyword">is</span> <span class="string">'asc'</span>
        params.order = <span class="string">'desc'</span>

    params = _removeDefaults.call <span class="keyword">this</span>, params</div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The collection can provide a <code>getPageURL</code> method to be used to generate
the href for page links.</p></div></div><div class="code"><div class="wrapper">    <span class="keyword">if</span> <span class="property">@getPageURL</span>
      <span class="property">@getPageURL</span> params
    <span class="keyword">else</span>
      utils.reverse <span class="property">@syncKey</span>, <span class="literal">null</span>, params

  <span class="function"><span class="title">exports</span> = -&gt;</span>
    <span class="property">@before</span> <span class="string">'sync'</span>, <span class="function"><span class="params">(method, collection, opts)</span> -&gt;</span>
      <span class="keyword">if</span> method <span class="keyword">is</span> <span class="string">'read'</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add <code>params</code> to the collection.</p></div></div><div class="code"><div class="wrapper">        <span class="property">@params</span> = _collectParams.call <span class="keyword">this</span>, opts.query
        cleanParams = _removeDefaults.call <span class="keyword">this</span>, <span class="property">@params</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only show <code>params</code> that aren&#39;t defaults in URL.</p></div></div><div class="code"><div class="wrapper">        opts.data =
          <span class="keyword">if</span> opts.data
            _.extend opts.data, cleanParams
          <span class="keyword">else</span>
            cleanParams

    <span class="property">@scopedUrl</span> = scopedUrl

    <span class="keyword">this</span></div></div></div><div id="segment-footer"><div id="footer"><a href="https://github.com/druide/citare-scriptum" target="_blank">Generated by Citare scriptum</a></div></div></div></body></html>